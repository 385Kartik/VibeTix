{% extends "base.html" %}
{% block start %}
<div class="container mt-4">
    {% if not user.is_authenticated or not user.is_staff %}
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <h4 class="fw-bold text-center mb-4">Admin Login</h4>
                    <form method="POST" action="{% url 'admin_login' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0">Admin Dashboard</h4>
            <p class="text-muted mb-0">Welcome, {{ user.username }}</p>
        </div>
        <a href="{% url 'admin_logout' %}" class="btn btn-outline-danger">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right me-2" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
            Logout
        </a>
    </div>

    <!-- Order Filtering -->
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="dateFilter" class="form-label">Filter by Date</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="statusFilter" class="form-label">Filter by Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="search" class="form-label">Search Orders</label>
                        <input type="text" class="form-control" id="search" placeholder="Search by order ID or customer...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card shadow-lg border-0">
        <div class="card-body">
            <h5 class="fw-bold mb-4">All Orders</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>{{ order.user.username }}</td>
                            <td>{{ order.created_at|date:"M d, Y" }}</td>
                            <td>{{ order.items.count }} items</td>
                            <td>â‚¹{{ order.total }}</td>
                            <td>
                                <span class="badge {% if order.status == 'completed' %}bg-success{% elif order.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary view-order" data-order-id="{{ order.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-success update-status" data-order-id="{{ order.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetails">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // View order details
    $('.view-order').click(function() {
        const orderId = $(this).data('order-id');
        $.ajax({
            url: `{% url 'get_order_details' %}?order_id=${orderId}`,
            type: 'GET',
            success: function(response) {
                $('#orderDetails').html(response);
                $('#orderModal').modal('show');
            }
        });
    });

    // Update order status
    $('.update-status').click(function() {
        const orderId = $(this).data('order-id');
        $.ajax({
            url: '{% url "update_order_status" %}',
            type: 'POST',
            data: {
                'order_id': orderId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    location.reload();
                }
            }
        });
    });

    // Filter functionality
    $('#dateFilter, #statusFilter').change(filterOrders);
    $('#search').keyup(filterOrders);

    function filterOrders() {
        const date = $('#dateFilter').val();
        const status = $('#statusFilter').val();
        const search = $('#search').val().toLowerCase();

        $('tbody tr').each(function() {
            const row = $(this);
            const rowDate = row.find('td:eq(2)').text();
            const rowStatus = row.find('td:eq(5)').text().toLowerCase();
            const searchText = row.find('td:eq(0)').text().toLowerCase() + ' ' + 
                             row.find('td:eq(1)').text().toLowerCase();

            const dateMatch = !date || rowDate.includes(date);
            const statusMatch = !status || rowStatus.includes(status);
            const searchMatch = !search || searchText.includes(search);

            row.toggle(dateMatch && statusMatch && searchMatch);
        });
    }
});
</script>
{% endblock %}